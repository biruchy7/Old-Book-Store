<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders - Old Book Store</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/order.css') }}" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
</head>

<body>
  <!-- Navigation -->
  <section id="header">
    <div id="logo">
      <a href="{{ url_for('home') }}">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="OldBookStore.com" />
      </a>
    </div>
    <div>
      <ul id="navbar">
        <li><a href="{{ url_for('home') }}">Home</a></li>
        <li><a href="{{ url_for('buy') }}">Buy</a></li>
        <li><a href="{{ url_for('sell') }}">Sell</a></li>
        <li><a href="{{ url_for('orders') }}" class="active">Orders</a></li>
        <li><a href="{{ url_for('wishlist') }}">Wishlist</a></li>
        <li><a href="{{ url_for('messages') }}">Messages</a></li>
        {% if session.get('user_id') %}
          <li>Welcome, {{ session.get('username') }}</li>
          <li><a href="{{ url_for('logout') }}">Logout</a></li>
        {% else %}
          <li><a href="{{ url_for('login') }}">Login/Register</a></li>
        {% endif %}
      </ul>
    </div>
  </section>

    <!-- Orders Section -->
  <main class="order-container">
    <h2>Your Orders</h2>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="flash-message {{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {% if orders %}
      <div class="orders-list">
        {% for order in orders %}
          <div class="order-card">
            <a href="{{ url_for('book_detail', book_id=order.bookID) }}" class="order-title">
              {{ order.book_name }} by {{ order.author }}
            </a>

            <div class="order-details">
              <p><strong>Quantity:</strong> {{ order.quantity if order.quantity else 1 }}</p>
              <p><strong>Status:</strong> {{ order.status }}</p>
              <p><strong>Ordered on:</strong> {{ order.order_date.strftime('%Y-%m-%d') if order.order_date else 'N/A' }}</p>
              <p><strong>Total Paid:</strong> Rs {{ order.selling_price }}</p>

              <!-- ðŸŸ¢ NEW: Payment Method -->
              <p><strong>Payment Method:</strong>
                {% if order.payment_method %}
                  {{ order.payment_method }}
                {% else %}
                  <span style="color: gray;">N/A</span>
                {% endif %}
              </p>

              <!-- ðŸŸ¢ NEW: Payment Status -->
              <p><strong>Payment Status:</strong>
                {% if order.transaction_status %}
                  {% if order.transaction_status == 'Completed' %}
                    <span style="color: green; font-weight: bold;">{{ order.transaction_status }}</span>
                  {% elif order.transaction_status == 'Pending' %}
                    <span style="color: orange; font-weight: bold;">{{ order.transaction_status }}</span>
                  {% elif order.transaction_status == 'Failed' %}
                    <span style="color: red; font-weight: bold;">{{ order.transaction_status }}</span>
                  {% else %}
                    {{ order.transaction_status }}
                  {% endif %}
                {% else %}
                  <span style="color: gray;">No Payment Info</span>
                {% endif %}
              </p>
            </div>

            <!-- ðŸŸ  ORDER STATUS DISPLAY + ACTIONS -->
            {% if order.status == 'Pending' %}
              <p style="color: orange; font-weight: bold;">Order Pending</p>

              <!-- Cancel Order -->
              <form action="{{ url_for('cancel_order', order_id=order.id) }}" method="POST" style="display:inline-block; margin-top:10px;">
                <button type="submit"
                        onclick="return confirm('Are you sure you want to cancel this order?');"
                        style="background-color:#ff4500; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:4px;">
                  Cancel Order
                </button>
              </form>

            {% elif order.status == 'Shipped' %}
              <p style="color: blue; font-weight: bold;">Shipped - On the way</p>

            {% elif order.status == 'Delivered' %}
              <p style="color: green; font-weight: bold;">Delivered</p>

            {% elif order.status == 'Cancelled' %}
              <p style="color: red; font-weight: bold;">Order Cancelled</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="no-orders">You have no orders yet.</p>
    {% endif %}
  </main>


  <!-- Footer -->
  <footer class="section-p1">
    <div class="col">
      <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="OldBookStore Logo" />
      <h4>Contact</h4>
      <p><strong>Address:</strong> Dhangadhi, Kailali</p>
      <p><strong>Phone:</strong> +977 9848562356 / +977 9848757575</p>
      <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
    </div>
  </footer>

  <div class="copyright">
    &copy; www.OldBookStore.com All rights reserved.
  </div>
</body>

</html>
